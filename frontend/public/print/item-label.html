<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <title>Artikel-Etikett</title>
    <style>
      :root {
        color-scheme: only light;
      }
      body {
        margin: 0;
        font-family: 'Helvetica Neue', Arial, sans-serif;
        background: #f2f4f7;
      }
      .page {
        box-sizing: border-box;
        width: 148mm;
        height: 105mm;
        margin: 12mm auto;
        padding: 14mm 18mm;
        background: #fff;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.15);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        border-radius: 5mm;
      }
      header h1 {
        font-size: 18pt;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      header span {
        display: block;
        font-size: 11pt;
        margin-top: 4px;
        color: #475569;
      }
      .meta {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px 16px;
        font-size: 11pt;
      }
      .meta div strong {
        display: block;
        font-size: 9pt;
        letter-spacing: 0.6px;
        text-transform: uppercase;
        color: #6b7280;
        margin-bottom: 2px;
      }
      .qr-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 20px;
      }
      .qr-wrapper img,
      .qr-wrapper canvas {
        width: 150px;
        height: 150px;
        image-rendering: pixelated;
      }
      .error {
        color: #b91c1c;
        background: #fee2e2;
        padding: 10px 14px;
        border-radius: 4mm;
        margin: 16px;
        font-size: 12pt;
      }
      @media print {
        body {
          background: none;
        }
        .page {
          margin: 0;
          box-shadow: none;
          border-radius: 0;
        }
        .error {
          display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="page" id="page" hidden>
      <header>
        <h1 id="item-title">Artikel</h1>
        <span id="item-subtitle"></span>
      </header>
      <div class="meta">
        <div>
          <strong>Artikelnummer</strong>
          <span id="item-article"></span>
        </div>
        <div>
          <strong>Behälter</strong>
          <span id="item-box"></span>
        </div>
        <div>
          <strong>Standort</strong>
          <span id="item-location"></span>
        </div>
        <div>
          <strong>UUID</strong>
          <span id="item-uuid"></span>
        </div>
      </div>
      <div class="qr-wrapper">
        <div>
          <small>Payload:</small>
          <pre id="item-json" style="font-size: 8pt; max-width: 250px; white-space: pre-wrap;"></pre>
        </div>
        <img id="qrImage" alt="QR-Code" hidden />
        <canvas id="qrCanvas" hidden></canvas>
      </div>
    </div>
    <div class="error" id="error" hidden></div>
    <script>
      (function init() {
        const state = { payload: null, qrReady: false, requested: false };
        const errorEl = document.getElementById('error');
        const pageEl = document.getElementById('page');
        const qrCanvas = document.getElementById('qrCanvas');
        const qrImage = document.getElementById('qrImage');

        function drawMatrix(modules, margin) {
          if (!qrCanvas || !Array.isArray(modules) || modules.length === 0) {
            return false;
          }
          const ctx = qrCanvas.getContext('2d');
          if (!ctx) {
            return false;
          }
          try {
            const quietZone = Number.isFinite(margin) ? Math.max(0, Math.floor(margin)) : 4;
            const moduleCount = modules.length;
            const totalModules = moduleCount + quietZone * 2;
            const target = 320;
            const scale = Math.max(1, Math.floor(target / totalModules));
            const size = totalModules * scale;

            qrCanvas.width = size;
            qrCanvas.height = size;

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, size, size);
            ctx.fillStyle = '#000000';

            for (let row = 0; row < moduleCount; row += 1) {
              const rowData = modules[row];
              if (!Array.isArray(rowData)) continue;
              for (let col = 0; col < rowData.length; col += 1) {
                if (rowData[col]) {
                  const x = (col + quietZone) * scale;
                  const y = (row + quietZone) * scale;
                  ctx.fillRect(x, y, scale, scale);
                }
              }
            }
            qrCanvas.hidden = false;
            return true;
          } catch (err) {
            console.error('Failed to draw QR matrix', err);
            return false;
          }
        }

        function showError(message) {
          if (!errorEl) return;
          errorEl.textContent = message;
          errorEl.hidden = false;
          if (pageEl) pageEl.hidden = true;
        }

        function render(payload) {
          if (!payload || typeof payload !== 'object') {
            showError('Kein gültiger Payload vorhanden.');
            return;
          }
          try {
            const titleEl = document.getElementById('item-title');
            const subtitleEl = document.getElementById('item-subtitle');
            const artEl = document.getElementById('item-article');
            const boxEl = document.getElementById('item-box');
            const locationEl = document.getElementById('item-location');
            const uuidEl = document.getElementById('item-uuid');
            const jsonEl = document.getElementById('item-json');

            if (titleEl) titleEl.textContent = payload.id ? `Artikel ${payload.id.slice(-6).toUpperCase()}` : 'Artikel';
            if (subtitleEl) subtitleEl.textContent = payload.id || '';
            if (artEl) artEl.textContent = payload.articleNumber || '—';
            if (boxEl) boxEl.textContent = payload.boxId || 'Nicht zugeordnet';
            if (locationEl) locationEl.textContent = payload.location || 'Unbekannter Standort';
            if (uuidEl) uuidEl.textContent = payload.id || '—';
            if (jsonEl) jsonEl.textContent = JSON.stringify(payload, null, 2);

            if (pageEl) pageEl.hidden = false;

            const hasDataUri = typeof payload.qrDataUri === 'string' && payload.qrDataUri.startsWith('data:image/');
            if (qrImage) {
              if (hasDataUri) {
                qrImage.src = payload.qrDataUri;
                qrImage.hidden = false;
              } else {
                qrImage.hidden = true;
              }
            }

            let fallbackRendered = false;
            if (!hasDataUri && Array.isArray(payload.qrModules)) {
              fallbackRendered = drawMatrix(payload.qrModules, payload.qrMargin);
            }
            if (qrCanvas) {
              qrCanvas.hidden = hasDataUri ? true : !fallbackRendered;
            }
            if (!hasDataUri && !fallbackRendered) {
              console.warn('QR fallback rendering skipped: no modules available.');
            }
            state.payload = payload;
          } catch (err) {
            console.error('Render error', err);
            showError('Vorlage konnte nicht gerendert werden.');
          }
        }

        function tryFromStorage(key) {
          if (!key) return false;
          const stores = [];
          try {
            stores.push(window.localStorage);
          } catch (err) {
            console.warn('Local storage lookup for print payload failed', err);
          }
          try {
            stores.push(window.sessionStorage);
          } catch (err) {
            console.warn('Session storage lookup for print payload failed', err);
          }
          for (const store of stores) {
            if (!store) continue;
            try {
              const raw = store.getItem(key);
              if (!raw) {
                continue;
              }
              const payload = JSON.parse(raw);
              try {
                store.removeItem(key);
              } catch (removeErr) {
                console.warn('Failed to remove cached print payload key', removeErr);
              }
              render(payload);
              return true;
            } catch (err) {
              console.error('Failed to load payload from storage', err);
              showError('Payload konnte nicht gelesen werden.');
              return true;
            }
          }
          console.info('Kein zwischengespeicherter Payload gefunden, erwarte postMessage…');
          return false;
        }

        function requestPayload() {
          if (state.requested) {
            return;
          }
          if (!window.opener) {
            console.warn('Kein opener verfügbar, kann Payload nicht anfordern.');
            return;
          }
          let targetOrigin = '*';
          try {
            targetOrigin = window.location?.origin || '*';
          } catch (originErr) {
            console.warn('Konnte Ursprungs-URL der Druckvorlage nicht bestimmen', originErr);
          }
          if (targetOrigin === 'null') {
            targetOrigin = '*';
          }
          try {
            window.opener.postMessage({ type: 'print:request-payload' }, targetOrigin);
            state.requested = true;
            console.info('Payload beim opener angefordert…');
          } catch (err) {
            console.error('Konnte Payload-Anfrage nicht an opener senden', err);
          }
        }

        function handleMessage(event) {
          if (event.origin && event.origin !== 'null' && event.origin !== window.location.origin) {
            console.warn('Ignoring message from unexpected origin', event.origin);
            return;
          }
          try {
            let data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
            if (!data || typeof data !== 'object') {
              return;
            }
            if ('type' in data && data.type !== 'print:payload' && data.type !== 'print:request-payload') {
              return;
            }
            if (data.type === 'print:request-payload') {
              return;
            }
            if ('payload' in data && data.payload) {
              render(data.payload);
            }
          } catch (err) {
            console.error('Failed to parse postMessage payload', err);
            showError('Übertragene Daten ungültig.');
          }
        }

        try {
          window.addEventListener('message', handleMessage);
        } catch (err) {
          console.error('Konnte Listener für postMessage nicht registrieren', err);
        }

        const params = new URLSearchParams(window.location.search);
        const key = params.get('key');
        if (!tryFromStorage(key)) {
          console.warn('Warte auf Payload via postMessage…');
          requestPayload();
        }

        state.qrReady = true;
        if (!state.payload) {
          console.info('QR renderer initialisiert, warte auf Payload…');
          try {
            window.setTimeout(() => {
              if (!state.payload) {
                state.requested = false;
                requestPayload();
              }
            }, 1000);
          } catch (err) {
            console.warn('Konnte erneute Payload-Anfrage nicht planen', err);
          }
        } else {
          console.info('QR renderer aktiv – render erneut mit vorhandenem Payload.');
          render(state.payload);
        }
      })();
    </script>
  </body>
</html>
