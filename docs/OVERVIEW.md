# Project Overview

The mediator service coordinates warehouse inventory workflows by pairing a TypeScript/Node.js backend with a React frontend for managing boxes, items, and print assets. This overview gives a high-level snapshot of the system, plus references for architecture, planning, issues, and recent changes.

## Mission & Scope

- Provide API endpoints and background workers to manage boxes, items, QR scans, and CSV imports.
- Deliver a responsive React UI that surfaces search, detail, and import tooling for logistics teams.
- Maintain printable label templates and legacy scripts required for production operations.

## Project Parts

- **Backend services (`backend/`)** – API endpoints, background workflows, and integrations.
- **Frontend UI (`frontend/`)** – React screens for inventory operations, search, and printing.
- **Shared models (`models/`)** – TypeScript contracts shared across tiers.
- **Printing assets (`frontend/public/print/`)** – Label templates rendered by frontend and backend.
- **Data & media (`data/`, `media/`)** – CSV imports/exports, QR assets, and item imagery.
- **Agentic flows (`backend/agentic/`)** – AI-assisted enrichment pipeline with human review.

## Current Status (Broad)

- Backend and frontend share aligned TypeScript models and rely on dynamic action loading for API routes.
- CSV import/export, QR scanning, and print label flows are available and continue to receive incremental polish.
- Shopware support currently covers read-only product search plus a queued sync pipeline awaiting a real dispatch client.
- The legacy agentic runtime has been ported into the mediator under `backend/agentic/`; ongoing work focuses on stability and integration follow-through.
- In progress: grouping helpers for list and box detail item payloads to support summarized responses.

## Progress Updates
- Split search scoring into field-level scores (Suchbegriff, Hersteller, Artikelbeschreibung, Artikel_Nummer, ItemUUID, BoxID) with best-field logging for top results while keeping response payloads stable.
- Normalized export image path serialization to strip `/media/` prefixes so CSV outputs align with WebDAV storage layouts.
- Replaced BoxTag with a new LocationTag that resolves item locations through direct shelf placements or box/shelf lookups, with guarded logging and fallbacks for missing Standort data.
- Added Auf_Lager to item instance summaries with warnings for missing/non-numeric stock and hid the withdraw action for out-of-stock instance detail views while keeping navigation intact.
- Added shelf label projections for box/item list payloads and updated list rendering to prefer shelf labels with logging when labels are missing.
- Centralized BoxTag label fallbacks to prefer editable labels with normalization logging and shelf-label formatting only when no label is present, keeping IDs hidden by default across box surfaces.
- Refreshed item detail removal to reload item payloads after successful withdrawals, with logging for reload failures.
- Added a mobile overflow guard for the item detail Vorrat table to keep wide columns scrollable on small screens.
- Filtered item list queries to hide zero-stock instances while keeping reference-only listings intact and logged list filtering activation.
- Added a persisted Suchbegriff search term on item references to seed agentic search defaults and share through item payloads.
- Added an nginx reverse proxy service with TLS termination, Basic Auth, and rate limiting to protect all ingress traffic while keeping the mediator service unexposed directly.
- Added `PRINTER_SERVER` to configure the CUPS host used for print dispatches instead of relying on a hard-coded address.
- Added a configurable print preview directory override and routed preview downloads through it to keep container print paths aligned.
- Documented the need to restart mediator containers after restarting CUPS (`docker compose up -d --force-recreate`) so print volumes pick up the new inode state.
- Added Chromium to the runtime Docker image for headless PDF rendering and documented the matching `PRINT_RENDERER` configuration.
- Switched item media storage to use 6-digit Artikelnummer folder names (with legacy ItemUUID fallback) while keeping media listing and agentic transcripts aligned.
- Updated media enumeration to display every image in an item's Artikelnummer folder, regardless of source.
- Added confirmation before deleting item gallery media, renamed the modal action label, and wired remove payloads to delete targeted media assets reliably.
- Logged resolved media storage paths on startup, including local override support and clearer WebDAV fallback visibility.
- Validated WebDAV media directory configuration with absolute path checks and documented the required filesystem path format.
- Auto-save box photo uploads through the existing note-save move flow so notes and photo updates persist together with consistent status feedback.
- Added item detail media add/remove controls to update picture slots via the save-item endpoint with refreshed gallery state.
- Auto-save box photo uploads through the existing note-save move flow so notes and photo updates persist together with consistent status feedback, while clearing photo upload flags on success.
- Updated item detail instance tables to render quality badges (with `?` for unknown values) and keep Menge rows grouped with instance data in the UI.
- Documented all environment variables in a dedicated reference and expanded the example `.env` template to match runtime usage.
- Updated agentic prompt/echo messaging to reference Postgres-compatible SQL in preparation for the database migration.
- Added baseline tests for core backend actions (import, save, list, search, QR scan) with match/handle coverage and response assertions to reduce regression risk.
- Noted layout constraints: mobile stays flex single-column, grid only above the breakpoint, and the ItemDetail card swap keeps references left with Fotos right and stacked images.
- Added UI workflow tests for agentic trigger handling and match selection search error/cancel flows.
- Balanced wide-screen landing grids by letting item/box detail tables and activity lists span both columns for readability.
- Added grid span utilities and applied select layout spans on landing, item, and box detail cards for clearer wide/tall layouts.
- Clarified the recent highlights log by replacing an empty placeholder link with a concrete documentation note for easier tracking.
- Locked Einheit from edit flows in the UI and backend so existing item units remain immutable during reference updates.
- Added a post-import success dialog reload in the ZIP import UI to refresh visible data while logging failures to display the dialog or reload.
- Updated the recent activities list to label entity IDs more clearly and surface item Artikelbezeichnung details for faster scanning.
- Updated export generation to group item rows by Artikelnummer, quality, and box/location for more predictable CSV payloads, while keeping legacy identifiers minimal for reconciliation.
- Omitted ItemUUID columns from grouped CSV exports and blanked grouped ItemUUID values to avoid inconsistent instance references in backup/ERP feeds.
- Added media storage configuration toggles with validation and resolved media directory logging to keep development defaults predictable.
- Added explicit export modes so backup exports keep instance-level ItemUUIDs while ERP exports stay grouped and intentionally leave ItemUUIDs blank because grouped rows are not instance-specific.
TODO(export-docs): keep backup-vs-ERP export language aligned with grouped ItemUUID blanking and instanzscharf backup behavior.
- Normalized grouped item summaries to prefer instance sequence `1` (parsed from the trailing `-####` ItemUUID suffix, e.g. `-0001`) as the representative record while logging fallbacks when no canonical instance exists; this is a canonical display update, not an export/agentic/printing change.
- Isolated item reference updates in the save-item edit flow so instance fields stay untouched during metadata edits.
- Implemented reference-only edit payloads to keep item edit flows scoped to `item_refs` while logging and guarding against instance-field updates.
- Added item detail instance summaries to surface per-reference inventory visibility in the detail view payload/UI.
- Grouped item list and box detail rows in the frontend to surface counts while keeping list filtering and sorting aligned with grouped summaries.
- Shifted ItemUUID minting to the Artikelnummer-based `I-<Artikelnummer>-####` format.
- Adjusted item creation auto-printing to respect instance vs. bulk label policies and log partial print failures for follow-up.
- Logged legacy CSV schema detection during validation, added category-aware bulk quantity normalization for legacy imports, and skipped empty/failed rows with explicit telemetry.
- Added structured logging around Produkt schema legacy column mappings to improve import observability without widening data model scope.
- Updated instance item grouping and print quantity logic to use grouped counts while keeping `Auf_Lager` numeric for bulk items, with warnings for anomalous instance stock values.
- Isolated bulk Einheit=Menge items in grouped UI lists while surfacing Auf_Lager display quantities alongside instance counts for Stück items.
- Split bulk Einheit=Menge items into unique grouped rows keyed by ItemUUID and updated list displays to show `Auf_Lager`-based quantities alongside instance counts.
- Keyed agentic run bulk queueing and instance detail status summaries off ItemUUIDs, with aggregated agentic status now surfaced in grouped list views.
- Added instance-scoped search limits for add-item workflows to return more item rows while logging truncation for debugging.
- Added item list sorting by entry date (“Erfasst am”) using `Datum_erfasst` with UpdatedAt fallbacks and logging for invalid timestamps.
- Enabled deep search defaults for Kurzbeschreibung/Langtext matching while keeping the flag available for API callers.
- Included Kurzbeschreibung/Langtext in field-level search ranking when deep search is enabled, keeping payloads unchanged.
- Hid quantity details for non-bulk items in the detail view while logging invalid Einheit values to avoid confusion around instance counts.
- Swapped the recent activities card to a semantic table layout with reusable list styling for easier scanning.
- Split item detail metadata into reference/instance cards and surfaced additional instance metadata alongside a separate instances table card.
- Moved item detail actions so edit sits with reference data, instance withdrawal sits with instance data, and deletion is no longer exposed in the UI.
- Reworked search results to render as a compact list layout that aligns core item and box fields in a single row.
- Refined add-item dialog result rows with a compact layout to keep search actions visible while tightening spacing.
- Made item detail instance rows navigable to instance-specific detail pages while preserving reload behavior for the current instance.
- Added item detail API payloads to return explicit reference data alongside instance lists to keep item metadata separated.
- Added Einheit selection to the item creation basic info step so new items start with a default unit that flows into creation payloads.
- Shared shelf label formatting between box and item lists so shelf locations show location, floor, and shelf IDs consistently.
- Centralized shelf label formatting in the frontend to standardize Lagerort labels across box and item lists with safe parsing and logging.
- Normalized item creation quantity handling to keep Auf_Lager flowing through match selection and guard against missing payloads while clarifying bulk-vs-instance behavior in the UI.
- Aligned agentic close availability to allow closing in any non-running state while keeping running runs locked to prevent accidental termination.
- Migrated agentic run persistence to key off Artikel_Nummer with backfill logging and updated queue/index usage to align runs with item references.
- Removed ItemUUID fields from import-item agentic run payloads/logs and added Artikel_Nummer-scoped error logging around agentic persistence.
- Aligned relocation create-and-move flow with auto-print item label behavior to match creation-time printing expectations.
- Made box detail item rows open the representative item on click/keyboard while removing the redundant details action.
- Adjusted grouped list and box detail quantity display to use bulk Auf_Lager values for Menge items while logging parse failures.
- Fixed ItemUUID parsing to handle Artikelnummer-based identifiers even when legacy prefixes overlap, preventing creation-by-reference collisions.
- Refined landing page grid styles to keep single-column defaults and expand to responsive multi-column layouts at larger breakpoints.
- Removed the duplicated reference card from the item detail view to keep reference data displayed once.
- Reordered item detail cards so reference data appears in the primary card while photos sit in a dedicated Fotos card.
- Moved the reference edit action to the bottom of the reference card and matched the Fotos card height to the reference layout span.
- Reaffirmed landing page grid columns with a mobile-first single-column default and stepped breakpoints for medium and large screens.
- Restored mobile flex stacking for shared grid layouts while keeping landing grids in multi-column mode only at larger breakpoints.
- Increased the desktop container max-width cap at larger breakpoints to better use wide screens.
- Updated mobile container sizing to prevent overflow by constraining widths to the viewport.
- Constrained box detail mobile containers and summary grids to the viewport width with wrapping to avoid overflow on small screens.
- Added a pre-submit confirmation prompt when creating multiple Stück instances to avoid accidental multi-instance creation.
- Normalized agentic run handling to resolve canonical ItemUUIDs per Artikelnummer and skip reference-scoped runs when one already exists, with added logging for fallbacks and resolution failures.
- Reinforced non-bulk import creation to log requested quantities, mint each instance safely, and report final instance counts for multi-quantity imports.
- Stacked the Fotos media gallery in item detail cards to keep image tiles consistently sized in a vertical layout.
- Ensured item creation responses surface multi-instance ItemUUID lists with safe UI parsing and navigation-target logging for bulk creates.
- Prevented multi-instance import creation from reusing the same ItemUUID in a single batch by reserving minted identifiers during import response assembly.
- Extended the test harness matchers to cover Jest-style throw checks, call counts, and subset equality for objectContaining expectations.
- Updated container media configuration defaults so Dockerfile directory creation and compose volume mappings support WebDAV storage mode paths.
- Refined the stacked Fotos gallery layout to keep photo cards vertically aligned with consistent sizing.
- Realigned box detail summary cards into left/right columns, embedded inline item creation on the overview, and compacted the overview stats placement for a tighter landing layout.
- Moved the overview statistics card beneath the Erfassen entry and matched its width to the primary column for a clearer landing layout balance.
- Enabled item detail agentic close to upsert when no prior run exists, keeping close available for loaded items.
- Added a navigable location link on box detail summaries so valid shelf locations can be opened directly while keeping missing-location logging intact.
- Removed the edit-form media gallery header and made Foto 1 optional in item creation flows, aligning UI validation and labels with optional photo uploads.
- Batched item grouping warnings to handle unplaced items as a single bucket and reduce per-item log noise.
- Adjusted item detail row grouping to treat Menge as instance data and refreshed the Vorrat table to show UUID text with quality badges for clarity.
- Enabled nullable quality handling across shared models, persistence defaults, and creation flows while updating UI badges to show a `?` indicator when no quality is set.
- Hardened the agentic trigger failure handler with bound status-update flags and contextual logging to prevent SQL parameter crashes.
- Added an explicit event-level mapping for Updated events so observability metrics no longer default to error severity.
- Removed default quality coercion so null quality stays unset across models, persistence, and creation flows while preserving explicit payload overrides.
- Resolved local media directory overrides so MEDIA_DIR can be used with consistent relative-path resolution and logging for local storage mode.
- Improved WebDAV configuration feedback with explicit mount-path guidance, startup storage logging, and documentation warnings about URL-based WebDAV paths.
- Updated print label cards to use a standard action button so grid layouts stay consistent across the UI.
- Added item label selection prompts for gross vs small print rolls and wired a dedicated printer queue for small item labels.
- Removed media directory bundling from exports now that media lives in WebDAV, reducing export archive size.
- Added an inline "Hinzufügen" action on item detail pages for bulk (Menge) items to adjust stock with logged add-item calls.
- Set match-selection item creation payloads to send Quality as null so new items start ungraded, with logging to confirm the intended null state.
- Highlighted the current instance row in the item detail Vorrat table and ensured the table spans the full card width for clearer scanning.
- Ignored reference/langtext-derived quality during new item imports unless an explicit Quality parameter is provided, with logging when derived values are skipped.
- Replaced the item label type prompt with a modal selection in the print label button while keeping label type logging.
- Updated remove-item for non-bulk instances to zero stock and clear placement with new prepared statements and logging for consistent grouping.
- Replaced the item list Unterkategorie filter select with a datalist-backed input to support typed values while keeping filter normalization and unknown-value logging.
- Added null-quality grouping fallbacks (Artikelnummer + location) with batch logging to audit missing Quality/Artikelnummer inputs in grouped item responses.
- Hid the header title link on small screens to keep navigation icons visible in the header.
- Removed the unconditional touch start/end bindings from the item detail container to prevent global swipe handling by default.
- Updated UI labels and agentic prompt guidance to surface “Spezifikationen” while keeping the Langtext payload key unchanged for schema compatibility.
- Added a unified /api/export/data action that can bundle items, boxes, agentic runs, and labeled events into a single archive or JSON payload with filterable query parameters.
- Added agentic_runs.csv ingestion with Artikel_Nummer validation, row-level logging, and archive handling for agentic run restores.
- Added optional shelf label/notes inputs for shelf creation and shelf detail editing while keeping relocation shelf lookups unfiltered by category.
- Reset item detail agentic search terms on item changes and hydrate them from persisted Suchbegriff values after item load.
- Replaced the header back control with a home link, added mobile-only header button sizing, and logged navigation failures for the home shortcut.
- Staged the item list Unterkategorie input so keystrokes update a draft value while Enter commits the filter with logging.
- Included item reference Suchbegriff terms in search token-hit and exact-match scoring for refs and items to keep query behavior aligned with persisted metadata.
- Extended item/ref search SQL to include Hersteller exact-match coverage, added Hersteller/Suchbegriff short-circuit scoring, and warned when token hits land without exact-match fields populated.
- Tuned mobile header icon sizing to 30px square tap targets with slightly reduced icon font sizes for small screens.
- Added Suchbegriff to item reference lookups so save-item edits retain the persisted search term when edit payloads omit it.
- Added Suchbegriff fallback normalization in search queries, logging when empty values fall back to Artikelbeschreibung or Artikel_Nummer while keeping token-hit and exact-match scoring aligned.
- Added Suchbegriff to CSV export/import flows with Artikelbeschreibung fallback normalization and row-level logging to keep imports resilient.
- Updated item detail instance filtering to default missing stock to 1 for Stück rows while logging before/after counts for the Vorrat table.
- Added BoxTag primary/secondary shelf label rendering with explicit shelf-label warnings and optional raw ID lines for showId views.
- Updated RelocateBoxCard location selection labels to include shelf labels alongside parsed shelf formatting for relocation choices.
- Filtered item detail instance queries to exclude zero-stock rows while logging any unexpected zero-stock entries returned for visibility.
- Fixed the item detail entnehmen dialog so cancel no longer triggers the removal API call, with explicit cancellation logging.
- Stored reference score breakdowns during ref dedupe to reuse them in top-result logging without altering the response payload.
- Added minimal typed search score inputs for item/reference scoring to replace `any` while preserving existing response payloads.
- Refactored search field scoring into a shared helper for item/reference scoring while keeping exact-match and top-result logging structures intact.
- Guarded Suchbegriff updates to only persist during initial reference creation, logging ignored backend updates and frontend overrides while keeping item payloads unchanged.
- Refactored agentic bulk queue and run orchestration to key off Artikel_Nummer with reference-only coverage.
- Aligned list/find item projections to join agentic runs by Artikel_Nummer with default status fallbacks and empty Artikel_Nummer logging to prevent reference/instance confusion in list responses.
- Updated item detail agentic actions to use Artikel_Nummer reference identifiers with stricter logging for failed agentic requests.
- Gate the legacy agentic_runs reset to run only when the schema still lacks Artikel_Nummer, preventing repeat wipes after migration.
- Added events.csv import handling alongside CSV ingestion, with per-row validation and logging to skip invalid event rows while continuing the import.
- Replaced legacy agentic_runs resets with non-destructive warnings and a startup abort when Artikel_Nummer is missing, so manual migrations are required without deleting rows.
- Corrected CSV archive branch flow so events, agentic runs, and items buffering close cleanly and continue as expected after each branch.
- Resolved a csv-import merge conflict so per-CSV branches close cleanly with explicit continuations and stable cleanup logging.

## Documentation Map

- **Architecture & data flow** → [`docs/ARCHITECTURE.md`](ARCHITECTURE.md)
- **Current plans & next steps** → [`docs/PLANS.md`](PLANS.md)
- **Known issues & bugs** → [`docs/BUGS.md`](BUGS.md)
- **Recent changes** → [`docs/RECENT_HIGHLIGHTS.md`](RECENT_HIGHLIGHTS.md)
- **Setup & operations** → [`docs/setup.md`](setup.md)
- **Category taxonomy data** → [`docs/data_struct.md`](data_struct.md)
