<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mediator ‚Ä¢ Warehouse</title>
<link rel="stylesheet" href="/styles.css" />

<div class="container">
  <h1>Overview</h1>
  <div class="grid landing-grid">
    <!-- <div class="card">
      <h2>Navigation & Overview</h2>
      <ul>
        <li><a href="/">üè† Landing</a> ‚Äî this page</li>
        <li><a href="/api/overview">üìä API: Overview</a> ‚Äî counts, recent boxes & activity (JSON)</li>
        <li><a href="/api/boxes">üì¶ API: List Boxes</a></li>
        <li><a href="/api/search?material=A-1001">üîç API: Search Items (by material)</a></li>
        <li><a href="/api/items/ITEM-UUID-HERE">üìÑ API: Item detail (replace UUID)</a></li>
        <li><a href="/api/export/wms">‚¨áÔ∏è API: Export snapshot for WMS</a></li>
        <li><a href="ui/box/BOX-ID-HERE">üìç Box placement page (replace BoxID)</a></li>
        <li><a href="/ui/box/BOX-ID-HERE">üß≠ UI Action View for Box (replace BoxID)</a></li>
        <li><a href="/ui/item/ITEM-UUID-HERE">üß≠ UI Action View for Item (replace UUID)</a></li>
        <li><a href="/qr/ITEM-UUID-HERE">üîó QR redirect (to WMS if link exists)</a></li>
      </ul>
      <p class="muted">Replace <code>BOX-ID-HERE</code> or <code>ITEM-UUID-HERE</code> with real values from your
        database or CSV imports.</p>
    </div> -->

    <div class="card" id="find">
      <h2>Find items</h2>
      <div class="row">
        <input id="q" placeholder="Material, BOX-‚Ä¶, oder UUID" autofocus />
        <button class="btn" id="btnGo">Suchen</button>
      </div>
      <div id="findOut" class="list" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h2>Stats</h2>
      <div id="stats" class="list"></div>
      <div class="muted">Drucker: <span id="printerDot"></span></div>
      <div class="muted">Health: <span id="health">checking‚Ä¶</span></div>
    </div>

    <div class="card" id="import">
      <a class="linkcard" href="/ui/import">
        <div class="card">
          <h2>Daten Eingabe</h2>
          <p class="muted">Einzelnes Teil erfassen oder CSV-Datei hochladen.</p>
        </div>
      </a>
    </div>

    <!-- <div class="card">
      <h2>Shortcuts</h2>
      <div class="inline"><span class="kbd">/</span> focus search</div>
      <div class="inline"><span class="kbd">Enter</span> run search / open</div>
      <div class="inline"><span class="kbd">b</span> open Box view field</div>
      <div class="inline"><span class="kbd">i</span> open Item view field</div>
    </div> -->

    <div class="card">
      <h2 id="boxes">Recent boxes</h2>
      <div id="boxesOut" class="list">
        <div class="muted">Loading‚Ä¶</div>
      </div>
    </div>

    <div class="card">
      <h2 id="activity">Recent activity</h2>
      <div id="eventsOut" class="list">
        <div class="muted">Loading‚Ä¶</div>
      </div>
    </div>
  </div>
</div>

<!-- ----------------------- SCRIPT --------------------------- -->

<script>
  (function () {
    function $(id) { return document.getElementById(id); }

    // ----- Helpers for "Find items"
    function looksLikeUuid(s) {
      return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s);
    }
    function looksLikeBox(s) {
      return /^BOX[-\s_]\d{4}[-\s_]\d{3,}$/i.test(s);
    }

    // ----- Overview data (stats, boxes, events)
    async function overview() {
      const statsEl = $('stats'), boxesEl = $('boxesOut'), evEl = $('eventsOut');
      if (!statsEl || !boxesEl || !evEl) return;
      try {
        const r = await fetch('/api/overview');
        const d = await r.json();
        statsEl.innerHTML = `
        <div>Total boxes$$$$$: <b>${d.counts.boxes}</b></div>
        <div>Total items: <b>${d.counts.items}</b></div>
        <div>Items ohne WMS-Link: <b>${d.counts.itemsNoWms}</b></div>
      `;
        boxesEl.innerHTML = (d.recentBoxes || []).length
          ? d.recentBoxes.map(x => `
              <a class="linkcard" href="/ui/box/${encodeURIComponent(x.BoxID)}">    
        <div class="card">
              <div><b>${x.BoxID}</b></div>
              <div class="muted">Location: ${x.Location || '(unset)'} ¬∑ Updated: ${x.UpdatedAt || ''}</div>
            </div>`).join('')
          : '<div class="muted">No boxes yet.</div></a>';
        evEl.innerHTML = (d.recentEvents || []).length
          ? d.recentEvents.map(e => `
            <div class="card">
              <div><span class="pill">${e.EntityType}</span> <b class="mono">${e.EntityId}</b></div>
              <div>${e.CreatedAt} ‚Äî ${e.Event} ${e.Actor ? 'by ' + e.Actor : ''}</div>
            </div>`).join('')
          : '<div class="muted">No recent activity.</div>';
      } catch {
        statsEl.innerHTML = '<div class="muted">Failed to load overview</div>';
        boxesEl.innerHTML = '';
        evEl.innerHTML = '';
      }
    }

    // ----- Printer connectivity dot
    async function printer() {
      const dot = $('printerDot');
      if (!dot) return;
      try {
        const r = await fetch('/api/printer/status');
        const j = await r.json();
        dot.style.background = (r.ok && j.ok) ? '#1cbc2c' : '#d22';
        dot.title = j.ok ? 'connected' : (j.reason || 'not connected');
      } catch {
        dot.style.background = '#d22';
        dot.title = 'unreachable';
      }
    }

    // ----- Find logic (single input, auto-detect)
    async function runFind() {
      const input = $('q');
      const out = $('findOut');
      if (!input || !out) return;
      const v = (input.value || '').trim();
      out.innerHTML = '';
      if (!v) return;

      if (looksLikeUuid(v)) { location.href = '/ui/item/' + encodeURIComponent(v); return; }
      if (looksLikeBox(v)) {
        const norm = v.toUpperCase().replace(/\s|_/g, '-');
        location.href = '/ui/box/' + encodeURIComponent(norm);
        return;
      }

      // Fallback: material search
      const r = await fetch('/api/search?material=' + encodeURIComponent(v));
      const data = await r.json();
      out.innerHTML = (data.items || []).length
        ? data.items.map(it => `
          <div class="card">
            <div><b>${it.MaterialNumber || '(no material)'}</b> ¬∑ <span class="pill mono">${(it.ItemUUID || '').slice(-6).toUpperCase()}</span></div>
            <div class="muted">${it.Description || ''}</div>
            <div>Box: <a class="mono" href="/ui/box/${encodeURIComponent(it.BoxID)}">${it.BoxID}</a></div>
          </div>`).join('')
        : '<div class="muted">No items found.</div>';
    }

    // ----- Bindings (guarded)
    const btnGo = $('btnGo');
    if (btnGo) btnGo.addEventListener('click', runFind);
    const q = $('q');
    if (q) q.addEventListener('keydown', (e) => { if (e.key === 'Enter') runFind(); });

    // Keyboard shortcut to focus search
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
        if (q) { e.preventDefault(); q.focus(); }
      }
      if (e.key === 'Enter' && document.activeElement === q) runFind();
    });

    // Initial load
    overview();
    printer();
  })();
</script>



</html>