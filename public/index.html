<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mediator ‚Ä¢ Warehouse</title>
<link rel="stylesheet" href="/styles.css" />

<header class="header">
  <div class="nav">
    <div class="brand"><a href="/">Mediator</a></div>
    <nav style="margin-left:auto;display:flex;gap:12px">
      <a href="#find">Find</a>
      <a href="#boxes">Boxes</a>
      <a href="#activity">Activity</a>
      <a href="#import">Import</a>
    </nav>
  </div>
</header>

<div class="container">
  <h1>Overview</h1>
  <div class="grid landing-grid">
    <div class="card">
      <h2>Navigation & Overview</h2>
      <ul>
        <li><a href="/">üè† Landing</a> ‚Äî this page</li>
        <li><a href="/api/overview">üìä API: Overview</a> ‚Äî counts, recent boxes & activity (JSON)</li>
        <li><a href="/api/boxes">üì¶ API: List Boxes</a></li>
        <li><a href="/api/search?material=A-1001">üîç API: Search Items (by material)</a></li>
        <li><a href="/api/items/ITEM-UUID-HERE">üìÑ API: Item detail (replace UUID)</a></li>
        <li><a href="/api/export/wms">‚¨áÔ∏è API: Export snapshot for WMS</a></li>
        <li><a href="ui/box/BOX-ID-HERE">üìç Box placement page (replace BoxID)</a></li>
        <li><a href="/ui/box/BOX-ID-HERE">üß≠ UI Action View for Box (replace BoxID)</a></li>
        <li><a href="/ui/item/ITEM-UUID-HERE">üß≠ UI Action View for Item (replace UUID)</a></li>
        <li><a href="/qr/ITEM-UUID-HERE">üîó QR redirect (to WMS if link exists)</a></li>
      </ul>
      <p class="muted">Replace <code>BOX-ID-HERE</code> or <code>ITEM-UUID-HERE</code> with real values from your
        database or CSV imports.</p>
    </div>

    <div class="card">
      <h2 id="find">Find items</h2>
      <div class="row">
        <input id="mat" placeholder="Material number e.g. A-12345" autofocus />
        <button class="btn" id="btnSearch">Search</button>
      </div>
      <div class="row-3">
        <input id="goId" placeholder="BOX-2025-0001 or Item UUID" />
        <select id="goType">
          <option value="box">Box</option>
          <option value="item">Item</option>
        </select>
        <button class="btn" id="btnOpen">Open</button>
      </div>
      <div id="searchOut" class="list"></div>
    </div>

    <div class="card">
      <h2>Stats</h2>
      <div id="stats" class="list">
        <div class="muted">Loading‚Ä¶</div>
      </div>
      <div class="muted">Health: <span id="health">checking‚Ä¶</span></div>
    </div>

    <div class="card" id="import">
      <a class="linkcard" href="/ui/import">
        <div class="card">
          <h2>Daten Eingabe</h2>
          <p class="muted">Einzelnes Teil erfassen oder CSV-Datei hochladen.</p>
        </div>
      </a>
    </div>

    <!-- <div class="card">
      <h2>Shortcuts</h2>
      <div class="inline"><span class="kbd">/</span> focus search</div>
      <div class="inline"><span class="kbd">Enter</span> run search / open</div>
      <div class="inline"><span class="kbd">b</span> open Box view field</div>
      <div class="inline"><span class="kbd">i</span> open Item view field</div>
    </div> -->

    <div class="card">
      <h2 id="boxes">Recent boxes</h2>
      <div id="boxesOut" class="list">
        <div class="muted">Loading‚Ä¶</div>
      </div>
    </div>

    <div class="card">
      <h2 id="activity">Recent activity</h2>
      <div id="eventsOut" class="list">
        <div class="muted">Loading‚Ä¶</div>
      </div>
    </div>
  </div>
</div>

<script>
  async function health() {
    try {
      const r = await fetch('/');
      document.getElementById('health').textContent = r.ok ? 'OK' : ('HTTP ' + r.status);
      document.getElementById('health').className = r.ok ? 'ok' : 'err';
    } catch (e) {
      document.getElementById('health').textContent = 'unreachable';
      document.getElementById('health').className = 'err';
    }
  }

  async function overview() {
    try {
      const r = await fetch('/api/overview');
      const d = await r.json();

      // stats
      const s = document.getElementById('stats');
      s.innerHTML = `
      <div>Total boxes: <b>${d.counts.boxes}</b></div>
      <div>Total items: <b>${d.counts.items}</b></div>
      <div>Items without WMS link: <b>${d.counts.itemsNoWms}</b></div>
    `;

      // boxes
      const b = document.getElementById('boxesOut');
      b.innerHTML = (d.recentBoxes && d.recentBoxes.length)
        ? d.recentBoxes.map(x => `
        <div class="item">
          <div><a href="/ui/box/${encodeURIComponent(x.BoxID)}"><b>${x.BoxID}</b></a></div>
          <div class="muted">Location: ${x.Location || '(unset)'} ¬∑ Updated: ${x.UpdatedAt || ''}</div>
        </div>`).join('')
        : '<div class="muted">No boxes yet.</div>';

      // events
      const ev = document.getElementById('eventsOut');
      ev.innerHTML = (d.recentEvents && d.recentEvents.length)
        ? d.recentEvents.map(e =>
          `<div class="item">
           <div><span class="pill">${e.EntityType}</span> <b class="mono">${e.EntityId}</b></div>
           <div>${e.CreatedAt} ‚Äî ${e.Event} ${e.Actor ? 'by ' + e.Actor : ''}</div>
         </div>`).join('')
        : '<div class="muted">No recent activity.</div>';
    } catch (e) {
      document.getElementById('stats').innerHTML = '<div class="muted">Failed to load overview</div>';
      document.getElementById('boxesOut').innerHTML = '';
      document.getElementById('eventsOut').innerHTML = '';
    }
  }

  async function search() {
    const q = document.getElementById('mat').value.trim();
    const out = document.getElementById('searchOut');
    out.innerHTML = '';
    if (!q) return;
    const r = await fetch('/api/search?material=' + encodeURIComponent(q));
    const data = await r.json();
    if (!data.items || !data.items.length) {
      out.innerHTML = '<div class="muted">No items found.</div>'; return;
    }
    out.innerHTML = data.items.map(it => `
    <div class="card">
      <div><b>${it.MaterialNumber || '(no material)'}</b> ¬∑ <span class="pill mono">${(it.ItemUUID || '').slice(-6).toUpperCase()}</span></div>
      <div class="muted">${it.Description || ''}</div>
      <div>Box: <a class="mono" href="/ui/box/${encodeURIComponent(it.BoxID)}">${it.BoxID}</a></div>
      <div><a class="mono" href="/ui/item/${encodeURIComponent(it.ItemUUID)}">Open item ‚Üí</a></div>
    </div>`).join('');
  }

  async function uploadCsv() {
    const csv = document.getElementById('csv').value;
    const name = document.getElementById('csvName').value.trim() || 'items_upload.csv';
    const status = document.getElementById('csvStatus');
    status.textContent = 'Uploading‚Ä¶';
    try {
      const r = await fetch('/api/import', {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain', 'X-Filename': name },
        body: csv
      });
      const data = await r.json();
      status.textContent = r.ok ? `OK: ${data.message}` : `Error: ${data.error || r.status}`;
      overview();
    } catch (e) {
      status.textContent = 'Failed: ' + e.message;
    }
  }

  function openEntity() {
    const id = document.getElementById('goId').value.trim();
    const t = document.getElementById('goType').value;
    if (id) location.href = '/ui/' + t + '/' + encodeURIComponent(id);
  }

  document.getElementById('btnSearch').addEventListener('click', search);
  document.getElementById('btnUpload').addEventListener('click', uploadCsv);
  document.getElementById('btnOpen').addEventListener('click', openEntity);

  // Shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
      e.preventDefault(); document.getElementById('mat').focus();
    }
    if (e.key === 'Enter' && document.activeElement === document.getElementById('mat')) search();
    if (e.key === 'b') { document.getElementById('goType').value = 'box'; document.getElementById('goId').focus(); }
    if (e.key === 'i') { document.getElementById('goType').value = 'item'; document.getElementById('goId').focus(); }
  });

  health(); overview();
</script>

</html>