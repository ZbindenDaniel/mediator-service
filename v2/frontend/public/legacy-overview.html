<!doctype html>
<html lang="de">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mediator • Lager</title>
<link rel="stylesheet" href="/styles.css" />

<div class="container overview">
  <h1>Übersicht</h1>
  <div class="grid landing-grid">

    <div class="card" id="import">
      <a class="linkcard" href="/ui/import">
        <div class="card">
          <h2>Erfassen</h2>
          <p class="muted">Neue Box anlegen und Artikel erfassen</p>
        </div>
      </a>
    </div>

    <div class="card" id="find">
      <h2>Artikel finden</h2>
      <div class="row">
        <input id="q" placeholder="Material, BOX-…, oder UUID" autofocus />
        <button class="btn" id="btnGo">Suchen</button>
      </div>
      <div id="findOut" class="list" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h2>Statistiken</h2>
      <div id="stats" class="list"></div>
      <div class="muted">Drucker: <span id="printerDot"></span></div>
      <div class="muted">Status: <span id="health">prüfe…</span></div>
    </div>

    <div class="card">
      <h2 id="boxes">Letzte Boxen</h2>
      <div id="boxesOut" class="list">
        <div class="muted">Lädt…</div>
      </div>
    </div>

    <div class="card">
      <h2 id="activity">Letzte Aktivitäten</h2>
      <div id="eventsOut" class="list">
        <!-- <button class="btn" id="btnActivity">Öffnen</button> -->
      </div>
    </div>
  </div>
</div>

<!-- ----------------------- SCRIPT --------------------------- -->
<script>

  (function () {
    function $(id) { return document.getElementById(id); }

    // ----- Helpers for "Find items"
    function looksLikeUuid(s) {
      return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s);
    }
    function looksLikeBox(s) {
      return /^BOX[-\s_]\d{4}[-\s_]\d{3,}$/i.test(s);
    }

    // ----- Overview data (stats, boxes, events)
    async function overview() {
      const statsEl = $('stats'), boxesEl = $('boxesOut'); evEl = $('eventsOut');
      if (!statsEl || !boxesEl || !evEl) return;
      try {
        const r = await fetch('/api/overview');
        const d = await r.json();
        statsEl.innerHTML = `
        <div>Boxen gesamt <b>${d.counts.boxes}</b></div>
        <div>Artikel gesamt: <b>${d.counts.items}</b></div>
        <div>Artikel ohne WMS-Link: <b>${d.counts.itemsNoWms}</b></div>
      `;
        boxesEl.innerHTML = (d.recentBoxes || []).length
          ? d.recentBoxes.map(x => `
              <a class="linkcard" href="/ui/box/${encodeURIComponent(x.BoxID)}">    
        <div class="card">
              <div><b>${x.BoxID}</b></div>
              <div class="muted">Standort: ${x.Location || '(nicht gesetzt)'} · Aktualisiert: ${x.UpdatedAt || ''}</div>
            </div></a>
            <div class="spacer"></div>`).join('')
          : '<div class="muted">Noch keine Boxen.</div>';
        evEl.innerHTML = (d.recentEvents || []).length
          ? d.recentEvents.map(e => `
            <div class="card">
              <div>
                <span class="pill ${e.EntityType}">${e.EntityType}</span>
                <br>
                <b class="mono">${e.EntityId}</b>
              </div>
              <div>${formatDate(e.CreatedAt)} — ${e.Event} ${e.Actor ? 'von ' + e.Actor : ''}</div>
            </div>
            <div class="spacer"></div>`).join('')
          : '<div class="muted">Keine aktuellen Aktivitäten.</div>';
      } catch {
        statsEl.innerHTML = '<div class="muted">Übersicht konnte nicht geladen werden</div>';
        boxesEl.innerHTML = '';
        evEl.innerHTML = '';
      }
    }

    // ----- Drucker-Status
    async function printer() {
      const dot = $('printerDot');
      if (!dot) return;
      try {
        const r = await fetch('/api/printer/status');
        const j = await r.json();
        dot.style.background = (r.ok && j.ok) ? '#1cbc2c' : '#d22';
        dot.title = j.ok ? 'verbunden' : (j.reason || 'nicht verbunden');
      } catch {
        dot.style.background = '#d22';
        dot.title = 'nicht erreichbar';
      }
    }

    // ----- Find logic (single input, auto-detect)
    async function runFind() {
      const input = $('q');
      const out = $('findOut');
      if (!input || !out) return;
      const v = (input.value || '').trim();
      out.innerHTML = '';
      if (!v) return;

      if (looksLikeUuid(v)) { location.href = '/ui/item/' + encodeURIComponent(v); return; }
      if (looksLikeBox(v)) {
        const norm = v.toUpperCase().replace(/\s|_/g, '-');
        location.href = '/ui/box/' + encodeURIComponent(norm);
        return;
      }

      // Fallback: material search
      const r = await fetch('/api/search?material=' + encodeURIComponent(v));
      const data = await r.json();
      out.innerHTML = (data.items || []).length
        ? data.items.map(it => `
          <div class="card">
            <div>
              <b>${it.MaterialNumber || '(kein Artikel)'}</b>
              <br>
              <span class="pill  mono">${(it.ItemUUID || '').slice(-6).toUpperCase()}</span>
            </div>
            <div class="muted">${it.Description || ''}</div>
            <div>Box: <a class="mono" href="/ui/box/${encodeURIComponent(it.BoxID)}">${it.BoxID}</a></div>
          </div>`).join('')
        : '<div class="muted">Keine Artikel gefunden.</div>';
    }

    // ----- Bindings (guarded)
    const btnGo = $('btnGo');
    if (btnGo) btnGo.addEventListener('click', runFind);
    const q = $('q');
    if (q) q.addEventListener('keydown', (e) => { if (e.key === 'Enter') runFind(); });

    // Keyboard shortcut to focus search
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
        if (q) { e.preventDefault(); q.focus(); }
      }
      if (e.key === 'Enter' && document.activeElement === q) runFind();
    });

    // Initial load
    overview();
    printer();
  })();

  function formatDate(s) {
    const d = new Date(s);
    return d.toLocaleString(); // or customize as needed
  }
</script>



</html>