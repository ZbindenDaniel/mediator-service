version: '3.9'

services:
  # TODO(database-migration): Replace the transient Postgres bootstrap once production settings are finalised.
  postgres:
    image: postgres:16
    container_name: mediator-postgres
    environment:
      POSTGRES_USER: mediator
      POSTGRES_PASSWORD: mediator
      POSTGRES_DB: mediator
    volumes:
      - mediator-postgres:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB"']
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    restart: unless-stopped
  
  pgadmin:
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@revamp-it.ch
      PGADMIN_DEFAULT_PASSWORD: l1n2xk3rn4l!
    ports:
      - "5050:80"
    depends_on:
      - postgres

  mediator:
    image: ghcr.io/zbindendaniel/mediator-service:2.1
    env_file: .env
    container_name: mediator
    expose:
      - "8080"
    volumes:
      - mediator-data:/var/lib/mediator
      - mediator-media:/app/dist/backend/media
      - /mnt/shopbilder:/app/dist/backend/webDav
      - /run/cups/cups.sock:/run/cups/cups.sock
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy

# TODO(ingress-auth): Keep the proxy configuration aligned with docs/setup.md and secrets rotation steps.
 proxy:
    image: nginx:1.25-alpine
    container_name: mediator-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx/mediator.conf:/etc/nginx/conf.d/default.conf:ro
      - ./secrets/tls/tls.crt:/etc/nginx/tls/tls.crt:ro
      - ./secrets/tls/tls.key:/etc/nginx/tls/tls.key:ro
      - ./mediator_htpasswd:/etc/nginx/secrets/htpasswd:ro
    depends_on:
      - mediator
    restart: unless-stopped

volumes:
  mediator-data:
    name: mediator-data
  mediator-media:
    name: mediator-media
  mediator-postgres:
    name: mediator-postgres
  nginx-logs:
    name: nginx-logs

secrets:
  mediator_htpasswd:
    file: ./secrets/htpasswd
