version: '3.9'

services:
  # TODO(database-migration): Replace the transient Postgres bootstrap once production settings are finalised.
  postgres:
    image: postgres:16
    container_name: mediator-postgres
    environment:
      POSTGRES_USER: mediator
      POSTGRES_PASSWORD: mediator
      POSTGRES_DB: mediator
    volumes:
      - mediator-postgres:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB"']
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    restart: unless-stopped
  pgadmin:
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@revamp-it.ch
      PGADMIN_DEFAULT_PASSWORD: l1n2xk3rn4l!
    ports:
      - "5050:80"
    depends_on:
      - postgres

  mediator:
    image: ghcr.io/zbindendaniel/mediator-service:latest   # or docker.io/youruser/yourapp:1.3.0
    env_file: .env
    container_name: mediator
    # TODO(host-ollama): Monitor upstream changes that could remove the host gateway requirement once a containerised Ollama ships.
    expose:
      - "8080"
    environment:
      # Storage locations for persistent state.
      DB_PATH: /var/lib/mediator/mediator.sqlite
      DATABASE_URL: postgres://mediator:mediator@postgres:5432/mediator
      INBOX_DIR: /var/lib/mediator/inbox
      ARCHIVE_DIR: /var/lib/mediator/archive
      # TODO(media-storage): Keep media directory overrides aligned with Dockerfile defaults.
      MEDIA_STORAGE_MODE: webdav
      MEDIA_DIR: /app/dist/backend/webDav
      # Set to the externally reachable hostname or IP for generated links.
      PUBLIC_HOSTNAME: localhost
      # Additional environment variables may be supplied here to override defaults from backend/config.ts,
      # such as HTTP_PORT, HTTPS_PORT, PUBLIC_PORT, PUBLIC_ORIGIN, BASE_QR_URL, BASE_UI_URL, PUBLIC_PROTOCOL, etc.
      # Configure printing by setting PRINTER_QUEUE (and optionally LP_COMMAND / LPSTAT_COMMAND / PRINT_TIMEOUT_MS).
      # The in-process agentic orchestrator reuses these defaults; provide provider-specific overrides or secrets via an env_file.
      AGENTIC_MODEL_PROVIDER: ollama
      # TODO(host-ollama): Remove this once the stack ships an internal Ollama sidecar.
      AGENTIC_OLLAMA_BASE_URL: http://host.docker.internal:11434
      AGENTIC_OLLAMA_MODEL: gpt-oss:20b
      # Uncomment to enable OpenAI-compatible providers and inject credentials through env_file or secrets management.
      # AGENTIC_OPENAI_API_KEY: ""
      AGENTIC_OPENAI_BASE_URL: https://api.openai.com/v1
      AGENTIC_OPENAI_MODEL: gpt-4o-mini
      # Agentic runs dispatch immediately; no queue polling configuration is required.
      # Leave AGENT_API_BASE_URL unset to persist results in-process. Set it (and optionally AGENT_SHARED_SECRET)
      # when an external service should receive agentic result callbacks instead.
      # Provide API keys for third-party enrichment separately.
      TAVILY_API_KEY: "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"
      SEARCH_WEB_ALLOWED_ENGINES: google,duckduckgo,brave
    volumes:
      # Persist the mediator application state and inbox/archive content.
      - mediator-data:/var/lib/mediator
      # Persist generated media assets served by the backend.
      - /var/webdav/uploads:/app/dist/backend/webDav
      # Optional: mount TLS key/cert files and set TLS_CERT_PATH/TLS_KEY_PATH when enabling HTTPS support.
      # - ./secrets/tls/server.crt:/etc/mediator/tls/server.crt:ro
      # - ./secrets/tls/server.key:/etc/mediator/tls/server.key:ro
      # Optional: mount printer configuration files or device mappings if required for the target printer setup.
      # - ./config/printers:/etc/mediator/printers:ro
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy

  # TODO(ingress-auth): Keep the proxy configuration aligned with docs/setup.md and secrets rotation steps.
  proxy:
    image: nginx:1.25-alpine
    container_name: mediator-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx/mediator.conf:/etc/nginx/conf.d/default.conf:ro
      - ./secrets/tls/tls.crt:/etc/nginx/tls/tls.crt:ro
      - ./secrets/tls/tls.key:/etc/nginx/tls/tls.key:ro
      - nginx-logs:/var/log/nginx
    secrets:
      - source: mediator_htpasswd
        target: /etc/nginx/secrets/htpasswd
    depends_on:
      - mediator
    restart: unless-stopped

volumes:
  mediator-data:
    name: mediator-data
  mediator-media:
    name: mediator-media
  mediator-postgres:
    name: mediator-postgres
  nginx-logs:
    name: nginx-logs

secrets:
  mediator_htpasswd:
    file: ./secrets/htpasswd
